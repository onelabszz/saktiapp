<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda Surat - Sakti App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#FF9000', primaryDark: '#e68200', surface: '#fdfbf7', secondary: '#334155' },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .hidden-view { display: none !important; }
        .toast { position: fixed; top: 24px; left: 50%; transform: translateX(-50%); z-index: 9999; background: #1e293b; color: white; padding: 14px 24px; border-radius: 50px; font-size: 14px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        @keyframes slideDown { from { opacity: 0; transform: translate(-50%, -30px); } to { opacity: 1; transform: translate(-50%, 0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .input-field { width: 100%; padding: 14px 16px; border-radius: 16px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 600; font-size: 14px; outline: none; transition: all; color: #334155; }
        .input-field:focus { background: white; border-color: #FF9000; box-shadow: 0 0 0 4px rgba(255, 144, 0, 0.1); }
        .input-field:disabled { background: #e2e8f0; color: #64748b; cursor: not-allowed; }
        .label-text { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #94a3b8; margin-bottom: 6px; display: block; letter-spacing: 0.05em; margin-left: 4px; }
        
        /* Presisi Navbar Mobile */
        .bottom-nav-glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(226, 232, 240, 0.8); }
    </style>
</head>
<body class="bg-surface text-slate-800 font-sans h-screen overflow-hidden flex selection:bg-orange-200">

    <div id="toast-container"></div>
    <div id="loading-overlay" class="hidden-view fixed inset-0 bg-white/95 z-[100] flex items-center justify-center flex-col backdrop-blur-sm">
        <div class="animate-spin text-primary mb-3"><i data-lucide="loader-2" width="48" height="48"></i></div>
        <p class="text-slate-500 font-medium text-sm tracking-wide">Memproses Data...</p>
    </div>

    <div id="view-login" class="fixed inset-0 z-50 bg-[#FF9000] flex items-center justify-center p-6">
        <div class="absolute inset-0 bg-gradient-to-br from-[#FF9000] to-[#E65100]"></div>
        <div class="w-full max-w-sm bg-white/95 backdrop-blur-xl rounded-[2rem] shadow-2xl p-8 relative z-10 text-center">
            <div class="w-24 h-24 bg-white/20 backdrop-blur-md rounded-[1.5rem] mx-auto flex items-center justify-center mb-6 p-2">
                <div class="w-full h-full bg-white rounded-[1.2rem] flex items-center justify-center text-primary shadow-sm"><i data-lucide="mail-open" width="40" height="40"></i></div>
            </div>
            <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">AGENDA SURAT</h1>
            <p class="text-slate-500 text-sm mb-8 font-medium">SDN 3 Krisak</p>
            <form onsubmit="app.handleLogin(event)" class="space-y-4">
                <input type="text" id="login-user" class="input-field" placeholder="Username">
                <input type="password" id="login-pass" class="input-field" placeholder="Password">
                <button type="submit" class="w-full py-4 bg-gradient-to-r from-[#FF9000] to-[#FF5500] text-white rounded-xl font-bold shadow-lg shadow-orange-200 hover:shadow-orange-300 transition transform active:scale-95 mt-4">MASUK</button>
            </form>
        </div>
    </div>

    <aside class="hidden md:flex w-64 bg-white border-r border-slate-200 flex-col z-20 shadow-sm relative">
        <div class="p-6 border-b border-orange-50 bg-gradient-to-br from-[#FF9000] to-[#FF5500] text-white">
            <h1 class="text-xl font-extrabold flex items-center gap-2"><i data-lucide="mail-open"></i> SAKTI APP</h1>
            <p class="text-xs text-orange-100 mt-1 font-medium">Agenda Surat Digital</p>
        </div>
        <div class="p-4 space-y-2 flex-grow">
            <div class="px-4 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Menu Utama</div>
            <button onclick="app.switchTab('keluar')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-orange-50 hover:text-primary transition flex items-center gap-3 font-medium text-slate-500" data-target="keluar"><i data-lucide="send" width="18"></i> Surat Keluar</button>
            <button onclick="app.switchTab('masuk')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-orange-50 hover:text-primary transition flex items-center gap-3 font-medium text-slate-500" data-target="masuk"><i data-lucide="inbox" width="18"></i> Surat Masuk</button>
            <div class="px-4 py-2 mt-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest border-t border-slate-100 pt-4">Laporan</div>
            <button onclick="app.openRekap()" class="w-full text-left px-4 py-3 rounded-xl hover:bg-emerald-50 hover:text-emerald-600 transition flex items-center gap-3 font-medium text-slate-500"><i data-lucide="file-spreadsheet" width="18"></i> Rekap Data</button>
        </div>
        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <div class="flex items-center gap-3 mb-4 px-2">
                <div class="w-10 h-10 rounded-full bg-white text-primary flex items-center justify-center font-bold shadow-sm border border-orange-100" id="sidebar-avatar">U</div>
                <div><p class="text-sm font-bold text-slate-700 leading-none mb-1" id="sidebar-name">User</p><p class="text-[10px] text-slate-400 font-medium bg-slate-200 px-2 py-0.5 rounded-full inline-block">Online</p></div>
            </div>
            <button onclick="app.logout()" class="w-full py-2.5 bg-white border border-slate-200 rounded-xl text-slate-500 hover:bg-red-50 hover:text-red-600 transition text-xs font-bold uppercase shadow-sm">Keluar</button>
        </div>
    </aside>

    <main class="flex-grow flex flex-col h-full relative overflow-hidden bg-[#fdfbf7] w-full">
        <div class="md:hidden bg-white/90 backdrop-blur-md border-b border-slate-100 p-4 flex justify-between items-center sticky top-0 z-30 shadow-sm">
            <div>
                <h1 class="text-lg font-extrabold text-slate-800 tracking-tight" id="mobile-title">Surat Keluar</h1>
                <p class="text-xs text-slate-400 font-medium">SDN 3 Krisak</p>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="app.openRekap()" class="w-9 h-9 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center shadow-sm"><i data-lucide="file-spreadsheet" width="18"></i></button>
                <div class="w-10 h-10 bg-gradient-to-br from-[#FF9000] to-[#FF5500] text-white rounded-full flex items-center justify-center font-bold shadow-md" id="mobile-avatar">U</div>
            </div>
        </div>

        <div class="flex-grow overflow-y-auto p-5 pb-40 md:p-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div class="hidden md:block">
                     <h2 class="text-2xl font-bold text-slate-800 tracking-tight" id="desktop-title">Surat Keluar</h2>
                     <p class="text-sm text-slate-500 font-medium mt-1">Kelola arsip surat sekolah dengan mudah.</p>
                </div>
                <div class="relative shadow-sm rounded-2xl bg-white w-full md:w-80 group focus-within:ring-2 focus-within:ring-orange-100 transition-all">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400 group-focus-within:text-primary"><i data-lucide="search" width="18"></i></div>
                    <input type="text" id="search-input" onkeyup="app.filterList()" class="block w-full pl-10 pr-3 py-3 border-none rounded-2xl leading-5 bg-white placeholder-slate-400 focus:outline-none sm:text-sm font-medium" placeholder="Cari nomor, perihal...">
                </div>
            </div>

            <div id="list-container" class="space-y-4 md:grid md:grid-cols-2 md:gap-5 md:space-y-0 lg:grid-cols-3"></div>
            
            <button onclick="app.openForm()" class="fixed bottom-28 right-5 md:bottom-10 md:right-10 w-16 h-16 bg-gradient-to-r from-[#FF9000] to-[#FF5500] text-white rounded-full shadow-[0_8px_30px_rgba(255,144,0,0.4)] hover:scale-105 active:scale-95 transition flex items-center justify-center z-40 border-4 border-[#fdfbf7]">
                <i data-lucide="plus" width="32"></i>
            </button>
        </div>

        <nav class="md:hidden fixed bottom-6 left-5 right-5 bottom-nav-glass rounded-[2rem] shadow-[0_10px_40px_rgba(0,0,0,0.1)] flex justify-between px-6 items-center h-[72px] z-40">
            <button onclick="app.switchTab('keluar')" class="nav-item group flex flex-col items-center gap-1 w-16" data-target="keluar">
                <div class="p-1.5 rounded-xl"><i data-lucide="send" width="22" class="text-slate-400"></i></div><span class="text-[10px] font-bold text-slate-400">Keluar</span>
            </button>
            <button onclick="app.switchTab('masuk')" class="nav-item group flex flex-col items-center gap-1 w-16" data-target="masuk">
                <div class="p-1.5 rounded-xl"><i data-lucide="inbox" width="22" class="text-slate-400"></i></div><span class="text-[10px] font-bold text-slate-400">Masuk</span>
            </button>
             <button onclick="app.logout()" class="nav-item group flex flex-col items-center gap-1 w-16">
                <div class="p-1.5 rounded-xl"><i data-lucide="log-out" width="22" class="text-slate-400"></i></div><span class="text-[10px] font-bold text-slate-400">Logout</span>
            </button>
        </nav>
    </main>

    <div id="modal-detail" class="hidden-view fixed inset-0 z-[70] bg-slate-900/60 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4">
        <div class="bg-surface w-full md:max-w-md rounded-t-[2.5rem] md:rounded-[2rem] shadow-2xl flex flex-col overflow-hidden transition-transform">
            <div class="p-6 border-b border-slate-100 flex justify-between items-start bg-white relative overflow-hidden">
                <div class="absolute -right-6 -top-6 w-32 h-32 bg-orange-50 rounded-full blur-2xl"></div>
                <div class="relative z-10 w-full">
                    <div class="flex justify-between items-center mb-3">
                        <span id="det-badge" class="px-3 py-1.5 rounded-lg text-xs font-bold border"></span>
                        <button onclick="app.closeDetail()" class="w-8 h-8 bg-slate-50 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-100"><i data-lucide="x" width="18"></i></button>
                    </div>
                    <h2 class="text-xl font-extrabold text-slate-800 leading-snug" id="det-perihal"></h2>
                    <p class="text-xs font-bold text-slate-400 mt-2 uppercase tracking-widest flex items-center gap-1"><i data-lucide="calendar" width="12"></i> <span id="det-tgl"></span></p>
                </div>
            </div>
            <div class="p-6 space-y-4 bg-[#fdfbf7]">
                <div class="bg-white p-4 rounded-2xl border border-slate-100 flex items-start gap-3 shadow-sm">
                    <div class="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center text-slate-400 flex-shrink-0"><i data-lucide="building" width="18"></i></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest" id="det-label-tujuan">Tujuan</p><p class="text-sm font-bold text-slate-700 mt-0.5" id="det-tujuan"></p></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Klasifikasi</p>
                        <p class="text-sm font-bold text-slate-700 mt-1" id="det-klas"></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest" id="det-label-sifat">Sifat</p>
                        <p class="text-sm font-bold text-slate-700 mt-1" id="det-sifat"></p>
                    </div>
                </div>
                <div id="det-file-container" class="hidden-view">
                    <a id="det-file-link" href="#" target="_blank" class="w-full py-3 bg-blue-50 text-blue-600 rounded-xl font-bold flex items-center justify-center gap-2 border border-blue-100 hover:bg-blue-100 transition"><i data-lucide="file-text" width="18"></i> Lihat File Dokumen</a>
                </div>
            </div>
            <div class="p-5 border-t border-slate-100 bg-white flex gap-3 pb-8 md:pb-5">
                <button onclick="app.openEdit()" class="flex-1 py-3.5 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition flex items-center justify-center gap-2"><i data-lucide="edit-3" width="18"></i> REVISI DATA</button>
            </div>
        </div>
    </div>

    <div id="modal-form" class="hidden-view fixed inset-0 z-[80] bg-slate-900/60 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4">
        <div class="bg-surface w-full md:max-w-2xl h-[92vh] md:h-auto md:max-h-[85vh] rounded-t-[2.5rem] md:rounded-[2rem] shadow-2xl flex flex-col overflow-hidden">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-white">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-orange-50 rounded-full flex items-center justify-center text-primary"><i data-lucide="pen-tool" width="20"></i></div>
                    <h2 class="text-lg font-bold text-slate-800" id="form-title">Buat Surat</h2>
                </div>
                <button onclick="app.closeForm()" class="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-100 transition"><i data-lucide="x" width="20"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto p-6 md:p-8 bg-[#fdfbf7]">
                <form id="main-form" class="space-y-6">
                    <div id="fields-keluar" class="hidden-view space-y-6">
                        <div class="p-4 bg-orange-50 rounded-2xl border border-orange-100 hidden-view" id="k-edit-warn"><p class="text-xs font-bold text-orange-600 flex items-center gap-2"><i data-lucide="alert-circle" width="16"></i> Mode Revisi: Tanggal & Nomor tidak bisa diubah.</p></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="label-text">Jenis Surat</label><select id="k_jenis" class="input-field" onchange="app.toggleSisipan()"><option value="UMUM">UMUM (Biasa)</option><option value="SK">SK (Keputusan)</option></select></div>
                            <div><label class="label-text">Mode Input</label><select id="k_mode" class="input-field" onchange="app.toggleSisipan()"><option value="auto">Otomatis</option><option value="sisipan">Sisipan</option></select></div>
                        </div>
                        <div id="box-sisipan" class="hidden-view p-4 bg-red-50 rounded-2xl border border-red-100"><label class="label-text text-red-500 mb-2">Sisip setelah No. Induk:</label><input type="number" id="k_nomorSisipan" class="input-field border-red-200" placeholder="Contoh: 5"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="label-text">Tanggal Surat</label><input type="date" id="k_tgl" class="input-field"></div>
                            <div><label class="label-text">Sifat</label><select id="k_sifat" class="input-field"><option value="B">Biasa</option><option value="P">Penting</option><option value="R">Rahasia</option></select></div>
                        </div>
                        <div><label class="label-text">Klasifikasi</label><input type="text" id="k_kode" class="input-field" list="listKlasifikasi" placeholder="Cari kode..."></div>
                        <div><label class="label-text">Tujuan Surat</label><input type="text" id="k_tujuan" class="input-field" placeholder="Kepada Yth..."></div>
                        <div><label class="label-text">Perihal</label><textarea id="k_perihal" rows="2" class="input-field resize-none"></textarea></div>
                        <div><label class="label-text">Upload File Opsional</label><input type="file" id="k_file" class="input-field bg-white py-2 text-xs text-slate-500"></div>
                    </div>
                    <div id="fields-masuk" class="hidden-view space-y-6">
                        <div class="p-4 bg-orange-50 rounded-2xl border border-orange-100 hidden-view" id="m-edit-warn"><p class="text-xs font-bold text-orange-600 flex items-center gap-2"><i data-lucide="alert-circle" width="16"></i> Mode Revisi: Tanggal & No Agenda terkunci.</p></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="label-text">Tgl Terima</label><input type="date" id="m_tglTerima" class="input-field"></div>
                            <div><label class="label-text">Tgl Surat</label><input type="date" id="m_tglSurat" class="input-field"></div>
                        </div>
                        <div><label class="label-text">Pengirim</label><input type="text" id="m_pengirim" class="input-field"></div>
                        <div><label class="label-text">Nomor Asli</label><input type="text" id="m_noAsli" class="input-field"></div>
                        <div><label class="label-text">Perihal</label><textarea id="m_perihal" rows="2" class="input-field resize-none"></textarea></div>
                        <div><label class="label-text">Klasifikasi</label><input type="text" id="m_kode" class="input-field" list="listKlasifikasi"></div>
                        <div><label class="label-text">Disposisi Ke</label><input type="text" id="m_disposisi" class="input-field" placeholder="Nama Guru..."></div>
                        <div><label class="label-text">Foto Surat Opsional</label><input type="file" id="m_file" class="input-field bg-white py-2 text-xs text-slate-500"></div>
                    </div>
                </form>
            </div>
            <div class="p-5 border-t border-slate-100 flex justify-end gap-3 bg-white pb-8 md:pb-5">
                <button onclick="app.closeForm()" class="px-6 py-3.5 rounded-xl text-slate-500 font-bold hover:bg-slate-50 transition text-sm">Batal</button>
                <button onclick="app.submitForm()" class="px-8 py-3.5 bg-gradient-to-r from-[#FF9000] to-[#FF5500] text-white rounded-xl font-bold shadow-lg shadow-orange-100 hover:shadow-orange-200 transition active:scale-95 text-sm">SIMPAN DATA</button>
            </div>
        </div>
    </div>

    <div id="modal-rekap" class="hidden-view fixed inset-0 z-[80] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl max-h-[90vh] rounded-[2rem] shadow-2xl flex flex-col overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-emerald-500 to-teal-600 text-white">
                <h2 class="text-lg font-bold flex items-center gap-2"><i data-lucide="file-spreadsheet"></i> Rekap Data Buku Agenda</h2>
                <button onclick="app.closeRekap()" class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/30"><i data-lucide="x" width="18"></i></button>
            </div>
            <div class="p-6 bg-slate-50 border-b border-slate-200 flex flex-wrap gap-3 items-end">
                <div class="flex-1 min-w-[120px]"><label class="label-text">Buku</label><select id="r_tipe" class="input-field"><option value="keluar">Surat Keluar</option><option value="masuk">Surat Masuk</option></select></div>
                <div class="w-24"><label class="label-text">Tahun</label><input type="number" id="r_tahun" class="input-field"></div>
                <div class="flex-1 min-w-[120px]"><label class="label-text">Bulan</label><select id="r_bulan" class="input-field"><option value="ALL">Semua</option><option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option><option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option><option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option><option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option></select></div>
                <button onclick="app.lihatRekap()" class="py-3.5 px-6 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-700 transition flex items-center gap-2"><i data-lucide="eye" width="18"></i> Lihat</button>
                <button onclick="app.downloadRekap()" class="py-3.5 px-6 bg-emerald-500 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 hover:shadow-emerald-300 transition flex items-center gap-2"><i data-lucide="download" width="18"></i> CSV</button>
            </div>
            <div class="flex-grow overflow-auto p-0" id="rekap-table-container">
                <div class="h-40 flex items-center justify-center text-slate-400 font-medium text-sm"><p>Klik "Lihat" untuk menampilkan tabel rekap</p></div>
            </div>
        </div>
    </div>

    <datalist id="listKlasifikasi"></datalist>

    <script>
        // ðŸ‘‡ðŸ‘‡ðŸ‘‡ PASTE LINK DEPLOY GAS ANDA DI SINI ðŸ‘‡ðŸ‘‡ðŸ‘‡
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLz6AOBL-QpZbkZc1uPrZ872jA-39ncshs3ZwFRDDlPuHZxUdBWE3DbeGl_F5HYKU6yw/exec";

        const app = {
            user: null, currentTab: 'keluar', data: {keluar:[], masuk:[]}, editingId: null, selectedItem: null,
            
            init: function() {
                const session = localStorage.getItem('sakti_surat_user');
                if(session) { this.user = JSON.parse(session); this.updateUserUI(); document.getElementById('view-login').classList.add('hidden-view'); this.fetchData(); this.fetchRef(); } 
                else { document.getElementById('view-login').classList.remove('hidden-view'); }
                if(document.getElementById('r_tahun')) document.getElementById('r_tahun').value = new Date().getFullYear();
                lucide.createIcons();
            },

            runApi: async function(payload) {
                try {
                    const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                    return await response.json();
                } catch (error) { return { status: 'error', message: 'Gagal terhubung ke server.' }; }
            },

            updateUserUI: function() {
                if(!this.user) return;
                const title = this.currentTab==='keluar'?'Surat Keluar':'Surat Masuk';
                if(document.getElementById('mobile-title')) document.getElementById('mobile-title').innerText = title;
                if(document.getElementById('desktop-title')) document.getElementById('desktop-title').innerText = title;
                if(document.getElementById('sidebar-name')) document.getElementById('sidebar-name').innerText = this.user.nama;
                ['sidebar-avatar', 'mobile-avatar'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerText = this.user.nama.charAt(0); });
            },

            switchTab: function(tab) {
                this.currentTab = tab; this.updateUserUI();
                document.querySelectorAll('.nav-btn, .nav-item').forEach(el => {
                    if(el.dataset.target === tab) {
                        el.classList.add('text-primary'); el.classList.remove('text-slate-500', 'text-slate-400');
                        if(el.querySelector('div')) el.querySelector('div').classList.add('bg-orange-50');
                        if(el.querySelector('i')) { el.querySelector('i').classList.add('text-primary'); el.querySelector('i').classList.remove('text-slate-400'); }
                        if(el.querySelector('span')) { el.querySelector('span').classList.add('text-primary'); el.querySelector('span').classList.remove('text-slate-400'); }
                    } else {
                        el.classList.remove('text-primary', 'bg-orange-50'); el.classList.add('text-slate-500');
                        if(el.querySelector('div')) el.querySelector('div').classList.remove('bg-orange-50');
                        if(el.querySelector('i')) { el.querySelector('i').classList.remove('text-primary'); el.querySelector('i').classList.add('text-slate-400'); }
                        if(el.querySelector('span')) { el.querySelector('span').classList.remove('text-primary'); el.querySelector('span').classList.add('text-slate-400'); }
                    }
                });
                this.renderList();
            },

            handleLogin: async function(e) {
                e.preventDefault(); this.toggleLoading(true);
                const res = await this.runApi({action:'login', user:document.getElementById('login-user').value, password:document.getElementById('login-pass').value});
                this.toggleLoading(false);
                if(res.status === 'success') { this.user = res.data; localStorage.setItem('sakti_surat_user', JSON.stringify(res.data)); this.init(); } 
                else this.showToast(res.message);
            },
            logout: function() { if(confirm('Keluar aplikasi?')) { localStorage.removeItem('sakti_surat_user'); location.reload(); } },

            fetchData: async function() {
                this.toggleLoading(true);
                const res = await this.runApi({action:'get_dashboard'});
                this.toggleLoading(false);
                if(res.status === 'success') { this.data = res.data; this.renderList(); }
            },
            fetchRef: async function() {
                 const res = await this.runApi({action:'get_ref'});
                 if(res.status === 'success') {
                    const dl = document.getElementById('listKlasifikasi'); dl.innerHTML = '';
                    res.data.forEach(x => { const opt = document.createElement('option'); opt.value = x[0]; opt.innerText = x[1]; dl.appendChild(opt); });
                }
            },

            renderList: function() {
                const list = this.data[this.currentTab] || [];
                const container = document.getElementById('list-container'); container.innerHTML = '';
                const keyword = document.getElementById('search-input') ? document.getElementById('search-input').value.toLowerCase() : "";
                const filtered = list.filter(item => JSON.stringify(item).toLowerCase().includes(keyword));

                if(filtered.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center py-20 text-slate-400 opacity-70"><div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-3"><i data-lucide="inbox" class="text-slate-300" width="36"></i></div><p class="font-medium text-sm">Tidak ada data ditemukan</p></div>';
                    lucide.createIcons(); return;
                }

                filtered.forEach(item => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-6 rounded-[1.5rem] shadow-card border border-slate-100 hover:border-orange-100 transition relative overflow-hidden group cursor-pointer active:scale-95";
                    el.onclick = () => this.openDetail(item.id);

                    let badge = '';
                    if(this.currentTab === 'keluar') {
                        const isSecret = (item.sifat === 'R' || item.sifat === 'SR');
                        const color = isSecret ? 'bg-red-50 text-red-600 border-red-100' : 'bg-orange-50 text-primary border-orange-100';
                        badge = `<span class="px-2.5 py-1 rounded-lg text-[10px] font-bold border ${color}">${item.no_full}</span>`;
                    } else { badge = `<span class="px-2.5 py-1 rounded-lg text-[10px] font-bold bg-green-50 text-green-600 border border-green-100">#${item.agenda}</span>`; }
                    
                    let fileBtn = item.file ? `<a href="${item.file}" target="_blank" onclick="event.stopPropagation()" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:text-primary hover:bg-orange-50 transition border border-slate-100"><i data-lucide="file-text" width="18"></i></a>` : '';

                    el.innerHTML = `
                        <div class="absolute left-0 top-0 bottom-0 w-1.5 ${this.currentTab === 'keluar' ? 'bg-primary' : 'bg-green-500'}"></div>
                        <div class="pl-4">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex flex-col"><span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5">${this.currentTab==='keluar' ? item.tgl : item.tgl_terima}</span><div>${badge}</div></div>
                                ${fileBtn}
                            </div>
                            <h3 class="font-bold text-slate-800 leading-snug mb-2 line-clamp-2 text-sm md:text-base group-hover:text-primary transition-colors">${item.perihal}</h3>
                            <div class="flex items-center gap-2 text-xs text-slate-500 pt-3 border-t border-slate-50 mt-2">
                                <i data-lucide="${this.currentTab==='keluar'?'user':'building'}" width="14" class="opacity-70"></i><span class="truncate font-medium">${this.currentTab==='keluar' ? item.tujuan : item.pengirim}</span>
                            </div>
                            ${this.currentTab === 'masuk' && item.disposisi ? `<div class="mt-3 text-[10px] bg-blue-50 px-3 py-1.5 rounded-lg inline-flex items-center gap-1.5 text-blue-600 font-bold border border-blue-100"><i data-lucide="forward" width="12"></i> ${item.disposisi}</div>` : ''}
                        </div>`;
                    container.appendChild(el);
                });
                lucide.createIcons();
            },
            filterList: function() { this.renderList(); },
            
            // --- FITUR DETAIL & EDIT ---
            openDetail: function(id) {
                const list = this.data[this.currentTab];
                this.selectedItem = list.find(x => x.id === id);
                if(!this.selectedItem) return;
                const i = this.selectedItem;

                document.getElementById('det-badge').innerText = this.currentTab === 'keluar' ? i.no_full : `Agenda #${i.agenda}`;
                document.getElementById('det-badge').className = this.currentTab === 'keluar' ? 'px-3 py-1.5 rounded-lg text-xs font-bold border bg-orange-50 text-primary border-orange-100' : 'px-3 py-1.5 rounded-lg text-xs font-bold border bg-green-50 text-green-600 border-green-100';
                
                document.getElementById('det-perihal').innerText = i.perihal;
                document.getElementById('det-tgl').innerText = this.currentTab === 'keluar' ? i.tgl : `Terima: ${i.tgl_terima} | Surat: ${i.tgl_surat}`;
                
                document.getElementById('det-label-tujuan').innerText = this.currentTab === 'keluar' ? 'Tujuan' : 'Pengirim';
                document.getElementById('det-tujuan').innerText = this.currentTab === 'keluar' ? i.tujuan : i.pengirim;
                
                document.getElementById('det-klas').innerText = i.kode_klas || '-';
                
                document.getElementById('det-label-sifat').innerText = this.currentTab === 'keluar' ? 'Sifat' : 'Disposisi Ke';
                document.getElementById('det-sifat').innerText = this.currentTab === 'keluar' ? i.sifat : (i.disposisi || '-');

                const fileBtn = document.getElementById('det-file-container');
                if(i.file) { fileBtn.classList.remove('hidden-view'); document.getElementById('det-file-link').href = i.file; }
                else { fileBtn.classList.add('hidden-view'); }

                document.getElementById('modal-detail').classList.remove('hidden-view');
            },
            closeDetail: function() { document.getElementById('modal-detail').classList.add('hidden-view'); },

            openForm: function() {
                this.editingId = null;
                document.getElementById('main-form').reset();
                this.setupFormState(false);
                document.getElementById('modal-form').classList.remove('hidden-view');
            },
            openEdit: function() {
                this.closeDetail();
                this.editingId = this.selectedItem.id;
                this.setupFormState(true);
                
                // Isi form dengan data lama
                const i = this.selectedItem;
                if(this.currentTab === 'keluar') {
                    document.getElementById('k_tgl').value = i.tgl_raw ? i.tgl_raw.split('T')[0] : '';
                    document.getElementById('k_jenis').value = i.jenis;
                    document.getElementById('k_sifat').value = i.sifat;
                    document.getElementById('k_kode').value = i.kode_klas;
                    document.getElementById('k_tujuan').value = i.tujuan;
                    document.getElementById('k_perihal').value = i.perihal;
                } else {
                    document.getElementById('m_tglTerima').value = i.tgl_terima_raw ? i.tgl_terima_raw.split('T')[0] : '';
                    document.getElementById('m_tglSurat').value = i.tgl_surat_raw ? i.tgl_surat_raw.split('T')[0] : '';
                    document.getElementById('m_pengirim').value = i.pengirim;
                    document.getElementById('m_noAsli').value = i.no_asli;
                    document.getElementById('m_perihal').value = i.perihal;
                    document.getElementById('m_kode').value = i.kode_klas;
                    document.getElementById('m_disposisi').value = i.disposisi;
                }
                document.getElementById('modal-form').classList.remove('hidden-view');
            },
            closeForm: function() { document.getElementById('modal-form').classList.add('hidden-view'); },

            setupFormState: function(isEdit) {
                document.getElementById('form-title').innerText = isEdit ? 'Revisi Surat' : (this.currentTab === 'keluar' ? 'Buat Surat Keluar' : 'Catat Surat Masuk');
                document.getElementById('fields-keluar').classList.toggle('hidden-view', this.currentTab !== 'keluar');
                document.getElementById('fields-masuk').classList.toggle('hidden-view', this.currentTab !== 'masuk');
                
                document.getElementById('k-edit-warn').classList.toggle('hidden-view', !(isEdit && this.currentTab === 'keluar'));
                document.getElementById('m-edit-warn').classList.toggle('hidden-view', !(isEdit && this.currentTab === 'masuk'));

                // Kunci Field jika Edit
                if(this.currentTab === 'keluar') {
                    document.getElementById('k_tgl').disabled = isEdit;
                    document.getElementById('k_jenis').disabled = isEdit;
                    document.getElementById('k_mode').disabled = isEdit;
                    if(isEdit) document.getElementById('box-sisipan').classList.add('hidden-view');
                } else {
                    document.getElementById('m_tglTerima').disabled = isEdit;
                    document.getElementById('m_tglSurat').disabled = isEdit;
                }
            },
            toggleSisipan: function() { if(!this.editingId) document.getElementById('box-sisipan').classList.toggle('hidden-view', document.getElementById('k_mode').value !== 'sisipan'); },

            submitForm: async function() {
                if(!confirm("Simpan data?")) return;
                this.toggleLoading(true);
                let payload = { action: this.editingId ? 'edit_surat' : `simpan_${this.currentTab}` };
                if(this.editingId) payload.id = this.editingId;
                payload.tipe = this.currentTab;

                if(this.currentTab === 'keluar') {
                    const f = document.getElementById('k_file');
                    Object.assign(payload, { jenis: document.getElementById('k_jenis').value, mode: document.getElementById('k_mode').value, nomorSisipan: document.getElementById('k_nomorSisipan').value, tglSurat: document.getElementById('k_tgl').value, sifat: document.getElementById('k_sifat').value, kodeKlas: document.getElementById('k_kode').value, tujuan: document.getElementById('k_tujuan').value, perihal: document.getElementById('k_perihal').value, tahun: new Date(document.getElementById('k_tgl').value).getFullYear(), bulanRom: this.getRomawi(new Date(document.getElementById('k_tgl').value).getMonth() + 1), pembuat: this.user.nama });
                    if(f.files.length>0) payload.fileBase64 = await this.toBase64(f.files[0]);
                } else {
                    const f = document.getElementById('m_file');
                    Object.assign(payload, { tglTerima: document.getElementById('m_tglTerima').value, tglSurat: document.getElementById('m_tglSurat').value, pengirim: document.getElementById('m_pengirim').value, noSuratAsli: document.getElementById('m_noAsli').value, perihal: document.getElementById('m_perihal').value, kodeKlas: document.getElementById('m_kode').value, disposisi: document.getElementById('m_disposisi').value, penerima: this.user.nama });
                    if(f.files.length>0) payload.fileBase64 = await this.toBase64(f.files[0]);
                }

                const res = await this.runApi(payload);
                this.toggleLoading(false);
                if(res.status === 'success') { this.showToast(res.message); this.closeForm(); this.fetchData(); } 
                else this.showToast(res.message);
            },

            // --- REKAP EXCEL & TABEL ---
            openRekap: function() { document.getElementById('modal-rekap').classList.remove('hidden-view'); },
            closeRekap: function() { document.getElementById('modal-rekap').classList.add('hidden-view'); },
            
            lihatRekap: async function() {
                const tipe = document.getElementById('r_tipe').value; const tahun = document.getElementById('r_tahun').value; const bulan = document.getElementById('r_bulan').value;
                this.toggleLoading(true);
                const res = await this.runApi({ action: 'get_rekap', tipe: tipe, tahun: tahun, bulan: bulan });
                this.toggleLoading(false);

                const container = document.getElementById('rekap-table-container');
                if (res.status === 'success' && res.data.rows.length > 0) {
                    let html = `<table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-100 text-slate-500 font-bold sticky top-0"><tr>`;
                    res.data.header.forEach(h => html += `<th class="p-3 border-b">${h}</th>`);
                    html += `</tr></thead><tbody>`;
                    res.data.rows.forEach((r, idx) => { html += `<tr class="${idx%2===0?'bg-white':'bg-slate-50'} hover:bg-orange-50">`; r.forEach(c => html += `<td class="p-3 border-b border-slate-100 max-w-[200px] truncate" title="${c}">${c}</td>`); html += `</tr>`; });
                    html += `</tbody></table>`;
                    container.innerHTML = html;
                } else { container.innerHTML = '<div class="h-40 flex items-center justify-center text-slate-400 font-medium">Tidak ada data di periode ini.</div>'; }
            },

            downloadRekap: async function() {
                const tipe = document.getElementById('r_tipe').value; const tahun = document.getElementById('r_tahun').value; const bulan = document.getElementById('r_bulan').value;
                this.toggleLoading(true); const res = await this.runApi({ action: 'get_rekap', tipe: tipe, tahun: tahun, bulan: bulan }); this.toggleLoading(false);
                if (res.status === 'success' && res.data.rows.length > 0) {
                    let csvContent = "\uFEFF" + res.data.header.join(",") + "\n";
                    res.data.rows.forEach(r => { csvContent += r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(",") + "\n"; });
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Buku_Agenda_${tipe}_${tahun}.csv`;
                    document.body.appendChild(link); link.click(); document.body.removeChild(link);
                } else this.showToast("Tidak ada data untuk diunduh!");
            },

            toBase64: function(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); }); },
            getRomawi: function(num) { const roman = {1:'I',2:'II',3:'III',4:'IV',5:'V',6:'VI',7:'VII',8:'VIII',9:'IX',10:'X',11:'XI',12:'XII'}; return roman[num]; },
            toggleLoading: function(show) { document.getElementById('loading-overlay').classList.toggle('hidden-view', !show); },
            showToast: function(msg) {
                const t = document.createElement('div'); t.className = 'toast'; t.innerHTML = `<i data-lucide="check-circle" width="16" class="text-emerald-400"></i> ${msg}`;
                document.getElementById('toast-container').appendChild(t); lucide.createIcons(); setTimeout(() => t.remove(), 3000);
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
