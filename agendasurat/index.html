<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda Surat - Sakti App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF9000', primaryDark: '#e68200',
                        surface: '#fdfbf7', secondary: '#334155',
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    boxShadow: { 'card': '0 4px 20px -2px rgba(0,0,0,0.05)' }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .hidden-view { display: none !important; }
        .toast {
            position: fixed; top: 24px; left: 50%; transform: translateX(-50%);
            z-index: 9999; background: #1e293b; color: white; padding: 14px 24px;
            border-radius: 50px; font-size: 14px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; font-weight: 500;
            border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 8px;
        }
        @keyframes slideDown { from { opacity: 0; transform: translate(-50%, -30px); } to { opacity: 1; transform: translate(-50%, 0); } }
        /* Scrollbar Halus */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-surface text-slate-800 font-sans h-screen overflow-hidden flex selection:bg-orange-200 selection:text-orange-900">

    <div id="toast-container"></div>
    <div id="loading-overlay" class="hidden-view fixed inset-0 bg-white/95 z-[100] flex items-center justify-center flex-col backdrop-blur-sm">
        <div class="animate-spin text-primary mb-3"><i data-lucide="loader-2" width="48" height="48"></i></div>
        <p class="text-slate-500 font-medium text-sm tracking-wide">Menghubungkan ke Server...</p>
    </div>

    <div id="view-login" class="fixed inset-0 z-50 bg-[#FF9000] flex items-center justify-center p-6">
        <div class="absolute inset-0 bg-gradient-to-br from-[#FF9000] via-[#FF6B00] to-[#E65100]"></div>
        <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 24px 24px;"></div>
        
        <div class="w-full max-w-sm bg-white/95 backdrop-blur-xl rounded-[2rem] shadow-2xl p-8 relative z-10 text-center animate-[scaleIn_0.3s_ease-out]">
            <div class="w-24 h-24 bg-white/20 backdrop-blur-md rounded-[1.5rem] mx-auto flex items-center justify-center mb-6 shadow-inner p-2">
                <div class="w-full h-full bg-white rounded-[1.2rem] flex items-center justify-center text-primary shadow-sm">
                     <i data-lucide="mail-open" width="40" height="40"></i>
                </div>
            </div>
            <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">AGENDA SURAT</h1>
            <p class="text-slate-500 text-sm mb-8 font-medium">Sakti App - SDN 3 Krisak</p>
            
            <form onsubmit="app.handleLogin(event)" class="space-y-4 text-left">
                <div class="relative group">
                    <input type="text" id="login-user" class="w-full px-4 py-3.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-4 focus:ring-orange-50 focus:border-primary outline-none transition font-bold text-slate-700 placeholder-transparent" placeholder="Username">
                    <label class="absolute left-4 top-[-10px] bg-white px-1 text-[10px] font-bold text-slate-400 uppercase tracking-wider transition-all">Username</label>
                </div>
                <div class="relative group mt-5">
                    <input type="password" id="login-pass" class="w-full px-4 py-3.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-4 focus:ring-orange-50 focus:border-primary outline-none transition font-bold text-slate-700 placeholder-transparent" placeholder="******">
                    <label class="absolute left-4 top-[-10px] bg-white px-1 text-[10px] font-bold text-slate-400 uppercase tracking-wider transition-all">Password</label>
                </div>
                <button type="submit" class="w-full py-4 bg-gradient-to-r from-[#FF9000] to-[#FF5500] text-white rounded-xl font-bold shadow-lg shadow-orange-200 hover:shadow-orange-300 transition transform active:scale-95 mt-4 tracking-wide">MASUK APLIKASI</button>
            </form>
            <p class="mt-8 text-[10px] text-slate-400 font-medium">Official App Â© 2026 SDN 3 Krisak</p>
        </div>
    </div>

    <aside class="hidden md:flex w-64 bg-white border-r border-slate-200 flex-col z-20 shadow-sm relative">
        <div class="p-6 border-b border-orange-50 bg-gradient-to-br from-[#FF9000] to-[#FF5500] text-white">
            <h1 class="text-xl font-extrabold flex items-center gap-2"><i data-lucide="mail-open"></i> SAKTI APP</h1>
            <p class="text-xs text-orange-100 opacity-90 mt-1 font-medium tracking-wide">Agenda Surat Digital</p>
        </div>
        <div class="p-4 space-y-2 flex-grow">
            <div class="px-4 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Menu Utama</div>
            <button onclick="app.switchTab('keluar')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-orange-50 hover:text-primary transition flex items-center gap-3 font-medium text-slate-500" data-target="keluar">
                <i data-lucide="send" width="18"></i> Surat Keluar
            </button>
            <button onclick="app.switchTab('masuk')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-orange-50 hover:text-primary transition flex items-center gap-3 font-medium text-slate-500" data-target="masuk">
                <i data-lucide="inbox" width="18"></i> Surat Masuk
            </button>
        </div>
        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <div class="flex items-center gap-3 mb-4 px-2">
                <div class="w-10 h-10 rounded-full bg-white text-primary flex items-center justify-center font-bold shadow-sm border border-orange-100" id="sidebar-avatar">U</div>
                <div>
                    <p class="text-sm font-bold text-slate-700 leading-none mb-1" id="sidebar-name">User</p>
                    <p class="text-[10px] text-slate-400 font-medium bg-slate-200 px-2 py-0.5 rounded-full inline-block">Online</p>
                </div>
            </div>
            <button onclick="app.logout()" class="w-full py-2.5 bg-white border border-slate-200 rounded-xl text-slate-500 hover:bg-red-50 hover:text-red-600 hover:border-red-100 transition text-xs font-bold uppercase tracking-wider shadow-sm">Keluar Aplikasi</button>
        </div>
    </aside>

    <main class="flex-grow flex flex-col h-full relative overflow-hidden bg-[#fdfbf7] w-full">
        <div class="md:hidden bg-white/80 backdrop-blur-md border-b border-slate-100 p-4 flex justify-between items-center sticky top-0 z-30 shadow-sm">
            <div>
                <h1 class="text-lg font-extrabold text-slate-800 tracking-tight" id="mobile-title">Surat Keluar</h1>
                <p class="text-xs text-slate-400 font-medium" id="mobile-subtitle">SDN 3 Krisak</p>
            </div>
            <div class="w-10 h-10 bg-gradient-to-br from-[#FF9000] to-[#FF5500] text-white rounded-full flex items-center justify-center font-bold shadow-md shadow-orange-200" id="mobile-avatar">U</div>
        </div>

        <div class="flex-grow overflow-y-auto p-5 pb-32 md:p-8" id="content-area">
            
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div class="hidden md:block">
                     <h2 class="text-2xl font-bold text-slate-800 tracking-tight" id="desktop-title">Surat Keluar</h2>
                     <p class="text-sm text-slate-500 font-medium mt-1">Kelola arsip surat sekolah dengan mudah.</p>
                </div>
                <div class="relative shadow-sm rounded-2xl bg-white w-full md:w-80 group focus-within:ring-2 focus-within:ring-orange-100 transition-all">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400 group-focus-within:text-primary transition-colors"><i data-lucide="search" width="18"></i></div>
                    <input type="text" id="search-input" onkeyup="app.filterList()" class="block w-full pl-10 pr-3 py-3 border-none rounded-2xl leading-5 bg-white placeholder-slate-400 focus:outline-none sm:text-sm transition-shadow font-medium text-slate-700" placeholder="Cari nomor, perihal...">
                </div>
            </div>

            <div class="md:hidden bg-gradient-to-br from-[#FF9000] via-[#FF6B00] to-[#FF5500] rounded-[2rem] p-6 text-white shadow-xl shadow-orange-200 mb-6 relative overflow-hidden">
                 <div class="absolute right-[-20px] top-[-20px] w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                 <div class="absolute left-[-20px] bottom-[-20px] w-24 h-24 bg-yellow-400/20 rounded-full blur-2xl"></div>
                 
                 <div class="relative z-10 flex justify-between items-end">
                     <div>
                        <p class="text-orange-100 text-[10px] font-bold uppercase tracking-widest mb-1">Ringkasan</p>
                        <h1 class="text-3xl font-extrabold mb-1" id="dash-total">0</h1>
                        <p class="text-orange-50 text-xs font-medium">Total Surat Tercatat</p>
                     </div>
                     <div class="w-12 h-12 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/10">
                         <i data-lucide="bar-chart-2" class="text-white"></i>
                     </div>
                 </div>
            </div>

            <div id="list-container" class="space-y-4 md:grid md:grid-cols-2 md:gap-5 md:space-y-0 lg:grid-cols-3 xl:grid-cols-3">
                </div>
            
            <button onclick="app.openForm()" class="fixed bottom-24 right-5 md:bottom-10 md:right-10 w-16 h-16 bg-gradient-to-r from-[#FF9000] to-[#FF5500] text-white rounded-full shadow-[0_8px_30px_rgba(255,144,0,0.4)] hover:scale-105 active:scale-95 transition flex items-center justify-center z-40 border-4 border-[#fdfbf7]">
                <i data-lucide="plus" width="32"></i>
            </button>
        </div>

        <nav class="md:hidden fixed bottom-6 left-5 right-5 bg-white/90 backdrop-blur-xl border border-white/50 rounded-[2rem] shadow-[0_8px_30px_rgba(0,0,0,0.08)] flex justify-between px-6 items-center h-[72px] z-40">
            <button onclick="app.switchTab('keluar')" class="nav-item group flex flex-col items-center gap-1 w-16" data-target="keluar">
                <div class="p-1.5 rounded-xl transition-colors"><i data-lucide="send" width="22" class="text-slate-400 transition"></i></div>
                <span class="text-[10px] font-bold text-slate-400 transition">Keluar</span>
            </button>
            <button onclick="app.switchTab('masuk')" class="nav-item group flex flex-col items-center gap-1 w-16" data-target="masuk">
                <div class="p-1.5 rounded-xl transition-colors"><i data-lucide="inbox" width="22" class="text-slate-400 transition"></i></div>
                <span class="text-[10px] font-bold text-slate-400 transition">Masuk</span>
            </button>
             <button onclick="app.logout()" class="nav-item group flex flex-col items-center gap-1 w-16">
                <div class="p-1.5 rounded-xl transition-colors"><i data-lucide="log-out" width="22" class="text-slate-400 transition"></i></div>
                <span class="text-[10px] font-bold text-slate-400 transition">Logout</span>
            </button>
        </nav>
    </main>

    <div id="modal-form" class="hidden-view fixed inset-0 z-[60] bg-slate-900/60 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4">
        <div class="bg-surface w-full md:max-w-2xl h-[92vh] md:h-auto md:max-h-[85vh] rounded-t-[2.5rem] md:rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden animate-[slideUp_0.3s_cubic-bezier(0.16,1,0.3,1)]">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-orange-50 rounded-full flex items-center justify-center text-primary"><i data-lucide="pen-tool" width="20"></i></div>
                    <h2 class="text-lg font-bold text-slate-800 tracking-tight" id="form-title">Buat Surat</h2>
                </div>
                <button onclick="app.closeForm()" class="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-100 transition active:scale-95"><i data-lucide="x" width="20"></i></button>
            </div>
            
            <div class="flex-grow overflow-y-auto p-6 md:p-8 bg-[#fdfbf7]">
                <form id="main-form" class="space-y-6">
                    
                    <div id="fields-keluar" class="hidden-view space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="label-text">Jenis Surat</label>
                                <div class="relative">
                                    <select id="k_jenis" class="input-field appearance-none" onchange="app.toggleSisipan()">
                                        <option value="UMUM">UMUM (Biasa)</option>
                                        <option value="SK">SK (Keputusan)</option>
                                    </select>
                                    <i data-lucide="chevron-down" width="16" class="absolute right-3 top-3.5 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>
                            <div>
                                <label class="label-text">Mode Input</label>
                                <div class="relative">
                                    <select id="k_mode" class="input-field appearance-none" onchange="app.toggleSisipan()">
                                        <option value="auto">Otomatis (Baru)</option>
                                        <option value="sisipan">Sisipan (Lupa)</option>
                                    </select>
                                    <i data-lucide="chevron-down" width="16" class="absolute right-3 top-3.5 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div id="box-sisipan" class="hidden-view p-4 bg-red-50 rounded-2xl border border-red-100">
                             <label class="label-text text-red-500 mb-2">Sisip setelah No. Induk:</label>
                             <input type="number" id="k_nomorSisipan" class="input-field border-red-200 focus:ring-red-100 bg-white placeholder-red-200" placeholder="Contoh: 5">
                             <p class="text-[10px] text-red-400 mt-2 font-medium flex items-center gap-1"><i data-lucide="info" width="12"></i> Surat akan diberi nomor 5.A, 5.B, dst.</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="label-text">Tanggal Surat</label>
                                <input type="date" id="k_tgl" class="input-field">
                            </div>
                            <div>
                                <label class="label-text">Sifat</label>
                                <div class="relative">
                                    <select id="k_sifat" class="input-field appearance-none">
                                        <option value="B">Biasa (B)</option>
                                        <option value="P">Penting (T)</option>
                                        <option value="R">Rahasia (R)</option>
                                    </select>
                                    <i data-lucide="chevron-down" width="16" class="absolute right-3 top-3.5 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="label-text">Klasifikasi</label>
                            <input type="text" id="k_kode" class="input-field" list="listKlasifikasi" placeholder="Cari kode atau ketik manual...">
                        </div>
                        <div>
                            <label class="label-text">Tujuan Surat</label>
                            <input type="text" id="k_tujuan" class="input-field" placeholder="Kepada Yth...">
                        </div>
                        <div>
                            <label class="label-text">Perihal</label>
                            <textarea id="k_perihal" rows="2" class="input-field resize-none leading-relaxed" placeholder="Isi ringkas surat..."></textarea>
                        </div>
                        <div>
                            <label class="label-text">Upload File (PDF/Foto)</label>
                            <input type="file" id="k_file" class="input-field bg-white py-2 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-[10px] file:font-bold file:uppercase file:tracking-wider file:bg-orange-50 file:text-primary hover:file:bg-orange-100">
                        </div>
                    </div>

                    <div id="fields-masuk" class="hidden-view space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="label-text">Tgl Terima</label>
                                <input type="date" id="m_tglTerima" class="input-field">
                            </div>
                            <div>
                                <label class="label-text">Tgl Surat</label>
                                <input type="date" id="m_tglSurat" class="input-field">
                            </div>
                        </div>
                        <div>
                            <label class="label-text">Pengirim</label>
                            <input type="text" id="m_pengirim" class="input-field" placeholder="Instansi / Perorangan">
                        </div>
                        <div>
                            <label class="label-text">Nomor Surat Asli</label>
                            <input type="text" id="m_noAsli" class="input-field" placeholder="Nomor dari pengirim">
                        </div>
                        <div>
                            <label class="label-text">Perihal</label>
                            <textarea id="m_perihal" rows="2" class="input-field resize-none leading-relaxed" placeholder="Isi ringkas..."></textarea>
                        </div>
                        <div>
                            <label class="label-text">Klasifikasi</label>
                            <input type="text" id="m_kode" class="input-field" list="listKlasifikasi" placeholder="Cari kode...">
                        </div>
                         <div>
                            <label class="label-text">Disposisi Ke</label>
                            <input type="text" id="m_disposisi" class="input-field" placeholder="Nama Guru...">
                        </div>
                        <div>
                            <label class="label-text">Foto Surat (Wajib)</label>
                            <input type="file" id="m_file" class="input-field bg-white py-2 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-[10px] file:font-bold file:uppercase file:tracking-wider file:bg-orange-50 file:text-primary hover:file:bg-orange-100">
                        </div>
                    </div>

                </form>
            </div>
            
            <div class="p-5 border-t border-slate-100 flex justify-end gap-3 bg-white pb-8 md:pb-5">
                <button onclick="app.closeForm()" class="px-6 py-3.5 rounded-xl text-slate-500 font-bold hover:bg-slate-50 transition text-sm">Batal</button>
                <button onclick="app.submitForm()" class="px-8 py-3.5 bg-gradient-to-r from-[#FF9000] to-[#FF5500] text-white rounded-xl font-bold shadow-lg shadow-orange-100 hover:shadow-orange-200 transition transform active:scale-95 text-sm tracking-wide">SIMPAN DATA</button>
            </div>
        </div>
    </div>

    <datalist id="listKlasifikasi"></datalist>

    <style>
        .input-field { width: 100%; padding: 14px 16px; border-radius: 16px; border: 1px solid #e2e8f0; background: #f8fafc; font-weight: 600; font-size: 14px; outline: none; transition: all; color: #334155; }
        .input-field:focus { background: white; border-color: #FF9000; box-shadow: 0 0 0 4px rgba(255, 144, 0, 0.1); }
        .label-text { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #94a3b8; margin-bottom: 6px; display: block; letter-spacing: 0.05em; margin-left: 4px; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>

    <script>
        // --- KONFIGURASI SCRIPT ANDA ---
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLz6AOBL-QpZbkZc1uPrZ872jA-39ncshs3ZwFRDDlPuHZxUdBWE3DbeGl_F5HYKU6yw/exec";

        const app = {
            user: null, currentTab: 'keluar', data: {keluar:[], masuk:[]},
            
            init: function() {
                const session = localStorage.getItem('sakti_surat_user');
                if(session) {
                    this.user = JSON.parse(session);
                    this.updateUserUI();
                    document.getElementById('view-login').classList.add('hidden-view');
                    this.fetchData();
                    this.fetchRef();
                } else {
                    document.getElementById('view-login').classList.remove('hidden-view');
                }
                const today = new Date().toISOString().split('T')[0];
                ['k_tgl','m_tglTerima','m_tglSurat'].forEach(id => {
                   if(document.getElementById(id)) document.getElementById(id).value = today;
                });
                lucide.createIcons();
            },

            // --- FUNGSI FETCH KE GOOGLE SCRIPT ---
            runApi: async function(payload) {
                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    return await response.json();
                } catch (error) {
                    return { status: 'error', message: 'Gagal terhubung ke server.' };
                }
            },

            updateUserUI: function() {
                const u = this.user;
                if(!u) return;
                const title = this.currentTab==='keluar'?'Surat Keluar':'Surat Masuk';
                if(document.getElementById('mobile-title')) document.getElementById('mobile-title').innerText = title;
                if(document.getElementById('desktop-title')) document.getElementById('desktop-title').innerText = title;
                ['sidebar-name'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerText = u.nama; });
                ['sidebar-avatar', 'mobile-avatar'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerText = u.nama.charAt(0); });
            },

            switchTab: function(tab) {
                this.currentTab = tab;
                this.updateUserUI();
                document.querySelectorAll('.nav-btn, .nav-item').forEach(el => {
                    const target = el.dataset.target;
                    const icon = el.querySelector('i');
                    const text = el.querySelector('span');
                    const iconContainer = el.querySelector('div');
                    
                    if(target === tab) {
                        el.classList.add('text-primary', 'bg-orange-50');
                        el.classList.remove('text-slate-500');
                        if(iconContainer) iconContainer.classList.add('bg-orange-50');
                        if(icon) { icon.classList.add('text-primary'); icon.classList.remove('text-slate-400'); }
                        if(text) { text.classList.add('text-primary'); text.classList.remove('text-slate-400'); }
                    } else {
                        el.classList.remove('text-primary', 'bg-orange-50');
                        el.classList.add('text-slate-500');
                        if(iconContainer) iconContainer.classList.remove('bg-orange-50');
                        if(icon) { icon.classList.remove('text-primary'); icon.classList.add('text-slate-400'); }
                        if(text) { text.classList.remove('text-primary'); text.classList.add('text-slate-400'); }
                    }
                });
                this.renderList();
            },

            handleLogin: async function(e) {
                e.preventDefault();
                this.toggleLoading(true);
                const u = document.getElementById('login-user').value;
                const p = document.getElementById('login-pass').value;
                
                const res = await this.runApi({action:'login', user:u, password:p});
                this.toggleLoading(false);
                
                if(res.status === 'success') {
                    this.user = res.data;
                    localStorage.setItem('sakti_surat_user', JSON.stringify(res.data));
                    this.init();
                } else this.showToast(res.message);
            },

            logout: function() {
                if(confirm('Keluar aplikasi?')) {
                    localStorage.removeItem('sakti_surat_user');
                    location.reload();
                }
            },

            fetchData: async function() {
                this.toggleLoading(true);
                const res = await this.runApi({action:'get_dashboard'});
                this.toggleLoading(false);
                if(res.status === 'success') {
                    this.data = res.data;
                    if(document.getElementById('dash-total')) document.getElementById('dash-total').innerText = res.data.keluar.length + res.data.masuk.length;
                    this.renderList();
                }
            },
            
            fetchRef: async function() {
                 const res = await this.runApi({action:'get_ref'});
                 if(res.status === 'success') {
                    const dl = document.getElementById('listKlasifikasi');
                    dl.innerHTML = '';
                    res.data.forEach(x => {
                        const opt = document.createElement('option'); opt.value = x[0]; opt.innerText = x[1]; dl.appendChild(opt);
                    });
                }
            },

            renderList: function() {
                const list = this.data[this.currentTab] || [];
                const container = document.getElementById('list-container');
                container.innerHTML = '';
                const keyword = document.getElementById('search-input').value.toLowerCase();
                const filtered = list.filter(item => JSON.stringify(item).toLowerCase().includes(keyword));

                if(filtered.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center py-20 text-slate-400 opacity-70"><div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-3"><i data-lucide="inbox" class="text-slate-300" width="36"></i></div><p class="font-medium text-sm">Tidak ada data ditemukan</p></div>';
                    lucide.createIcons(); return;
                }

                filtered.forEach(item => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-6 rounded-[1.5rem] shadow-[0_2px_15px_-4px_rgba(0,0,0,0.05)] border border-slate-100 hover:shadow-orange-100 hover:border-orange-100 transition relative overflow-hidden group";
                    
                    let badge = '';
                    if(this.currentTab === 'keluar') {
                        const isSecret = (item.sifat === 'R' || item.sifat === 'SR');
                        const color = isSecret ? 'bg-red-50 text-red-600 border-red-100' : 'bg-orange-50 text-primary border-orange-100';
                        badge = `<span class="px-2.5 py-1 rounded-lg text-[10px] font-bold border ${color}">${item.no_full}</span>`;
                    } else {
                        badge = `<span class="px-2.5 py-1 rounded-lg text-[10px] font-bold bg-green-50 text-green-600 border border-green-100">#${item.agenda}</span>`;
                    }
                    
                    let fileBtn = '';
                    if(item.file) {
                        fileBtn = `<a href="${item.file}" target="_blank" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:text-primary hover:bg-orange-50 transition shadow-sm border border-slate-100"><i data-lucide="file-text" width="18"></i></a>`;
                    }

                    el.innerHTML = `
                        <div class="absolute left-0 top-0 bottom-0 w-1.5 ${this.currentTab === 'keluar' ? 'bg-gradient-to-b from-[#FF9000] to-[#FF5500]' : 'bg-gradient-to-b from-green-400 to-green-600'}"></div>
                        <div class="pl-4">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex flex-col">
                                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5">${this.currentTab==='keluar' ? item.tgl : item.tgl_terima}</span>
                                    <div class="flex gap-2">${badge}</div>
                                </div>
                                ${fileBtn}
                            </div>
                            <h3 class="font-bold text-slate-800 leading-snug mb-2 line-clamp-2 text-sm md:text-base group-hover:text-primary transition-colors">${item.perihal}</h3>
                            <div class="flex items-center gap-2 text-xs text-slate-500 pt-3 border-t border-slate-50 mt-2">
                                <i data-lucide="${this.currentTab==='keluar'?'user':'building'}" width="14" class="opacity-70"></i>
                                <span class="truncate max-w-[200px] font-medium">${this.currentTab==='keluar' ? item.tujuan : item.pengirim}</span>
                            </div>
                            ${this.currentTab === 'masuk' && item.disposisi ? `<div class="mt-3 text-[10px] bg-blue-50 px-3 py-1.5 rounded-lg inline-flex items-center gap-1.5 text-blue-600 font-bold w-full border border-blue-100"><i data-lucide="forward" width="12"></i> ${item.disposisi}</div>` : ''}
                        </div>
                    `;
                    container.appendChild(el);
                });
                lucide.createIcons();
            },

            filterList: function() { this.renderList(); },
            
            openForm: function() {
                document.getElementById('modal-form').classList.remove('hidden-view');
                document.getElementById('form-title').innerText = this.currentTab === 'keluar' ? 'Buat Surat Keluar' : 'Catat Surat Masuk';
                document.getElementById('fields-keluar').classList.toggle('hidden-view', this.currentTab !== 'keluar');
                document.getElementById('fields-masuk').classList.toggle('hidden-view', this.currentTab !== 'masuk');
            },
            closeForm: function() { document.getElementById('modal-form').classList.add('hidden-view'); },
            toggleSisipan: function() {
                const mode = document.getElementById('k_mode').value;
                document.getElementById('box-sisipan').classList.toggle('hidden-view', mode !== 'sisipan');
            },

            submitForm: async function() {
                if(!confirm("Simpan data?")) return;
                this.toggleLoading(true);
                
                let payload = {};
                if(this.currentTab === 'keluar') {
                    const fileInput = document.getElementById('k_file');
                    let base64 = "";
                    if(fileInput.files.length > 0) base64 = await this.toBase64(fileInput.files[0]);
                    
                    payload = {
                        action: 'simpan_keluar',
                        jenis: document.getElementById('k_jenis').value,
                        mode: document.getElementById('k_mode').value,
                        nomorSisipan: document.getElementById('k_nomorSisipan').value,
                        tglSurat: document.getElementById('k_tgl').value,
                        sifat: document.getElementById('k_sifat').value,
                        kodeKlas: document.getElementById('k_kode').value,
                        tujuan: document.getElementById('k_tujuan').value,
                        perihal: document.getElementById('k_perihal').value,
                        tahun: new Date(document.getElementById('k_tgl').value).getFullYear(),
                        bulanRom: this.getRomawi(new Date(document.getElementById('k_tgl').value).getMonth() + 1),
                        pembuat: this.user.nama,
                        fileBase64: base64
                    };
                } else {
                    const fileInput = document.getElementById('m_file');
                    let base64 = "";
                    if(fileInput.files.length > 0) base64 = await this.toBase64(fileInput.files[0]);
                    
                    payload = {
                        action: 'simpan_masuk',
                        tglTerima: document.getElementById('m_tglTerima').value,
                        tglSurat: document.getElementById('m_tglSurat').value,
                        pengirim: document.getElementById('m_pengirim').value,
                        noSuratAsli: document.getElementById('m_noAsli').value,
                        perihal: document.getElementById('m_perihal').value,
                        kodeKlas: document.getElementById('m_kode').value,
                        disposisi: document.getElementById('m_disposisi').value,
                        penerima: this.user.nama,
                        fileBase64: base64
                    };
                }

                const res = await this.runApi(payload);
                this.toggleLoading(false);
                if(res.status === 'success') {
                    this.showToast(res.message);
                    this.closeForm();
                    document.getElementById('main-form').reset();
                    this.fetchData(); 
                } else this.showToast(res.message);
            },

            toBase64: function(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            },
            getRomawi: function(num) {
                const roman = { 1:'I', 2:'II', 3:'III', 4:'IV', 5:'V', 6:'VI', 7:'VII', 8:'VIII', 9:'IX', 10:'X', 11:'XI', 12:'XII' };
                return roman[num];
            },
            toggleLoading: function(show) { document.getElementById('loading-overlay').classList.toggle('hidden-view', !show); },
            showToast: function(msg) {
                const t = document.createElement('div'); t.className = 'toast'; 
                t.innerHTML = `<i data-lucide="check-circle" width="16" class="text-green-400"></i> ${msg}`;
                document.getElementById('toast-container').appendChild(t);
                lucide.createIcons();
                setTimeout(() => t.remove(), 3000);
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
