<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FF9000" id="meta-theme-color">
    <meta name="description" content="Portal Aplikasi SD Negeri 3 Krisak">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/onelabszz/saktiapp/refs/heads/main/sakti.png">
    <title>Sakti App SDN 3 Krisak</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: { primary: '#FF9000', primaryDark: '#e65100' },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    boxShadow: {
                        'glow': '0 0 20px rgba(255, 144, 0, 0.4)',
                        'card': '0 8px 25px -8px rgba(0,0,0,0.08)',
                        'soft': '0 4px 15px -2px rgba(0,0,0,0.04)',
                        'floating': '0 10px 30px -5px rgba(0,0,0,0.2)',
                    }
                }
            }
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Optimasi Native Feel: Mematikan efek karet bawaan browser */
        html, body {
            overscroll-behavior-y: none; 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            transition: background-color 0.2s ease; 
            user-select: none;
            -webkit-user-select: none;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Efek Ripple Widget Android */
        .ripple { position: relative; overflow: hidden; transform: translate3d(0, 0, 0); }
        .ripple:after {
            content: ""; display: block; position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat; background-position: 50%; transform: scale(10, 10); opacity: 0; transition: transform .4s, opacity 1s;
        }
        .ripple:active:after { transform: scale(0, 0); opacity: 0.2; transition: 0s; }
        
        /* Kustomisasi SweetAlert HP */
        .swal2-popup { border-radius: 1.5rem !important; font-family: 'Inter', sans-serif !important; width: 90% !important; max-width: 380px !important; }
        .dark .swal2-popup { background-color: #1e293b !important; color: #fdfbf7 !important; }
        .dark .swal2-title, .dark .swal2-html-container { color: #fdfbf7 !important; }

        @media all and (display-mode: standalone) { #install-prompt-container, #install-sheet-overlay { display: none !important; } }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-100 min-h-screen relative overflow-x-hidden md:flex md:justify-center bg-[#f4f6f8] dark:bg-slate-900 no-scrollbar pb-24 md:pb-0">

    <div class="fixed top-[-50px] left-[-50px] w-64 h-64 md:w-96 md:h-96 bg-orange-200/40 dark:bg-orange-900/10 rounded-full blur-3xl opacity-60 z-0 pointer-events-none"></div>
    <div class="fixed bottom-[-50px] right-[-50px] w-48 h-48 md:w-80 md:h-80 bg-yellow-200/40 dark:bg-yellow-900/10 rounded-full blur-3xl opacity-60 z-0 pointer-events-none"></div>

    <div id="loader" class="fixed inset-0 z-[100] bg-primary dark:bg-slate-900 flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="relative w-16 h-16 md:w-24 md:h-24 flex items-center justify-center mb-4 p-2 md:p-3 bg-white dark:bg-slate-800 rounded-2xl md:rounded-[2rem] shadow-card">
            <div class="absolute inset-0 border-[3px] md:border-4 border-slate-100 dark:border-slate-700 border-t-primary rounded-2xl md:rounded-[2rem] animate-spin"></div>
            <img src="https://raw.githubusercontent.com/onelabszz/saktiapp/refs/heads/main/sakti.png" class="w-10 h-10 md:w-16 md:h-16 object-contain animate-pulse">
        </div>
    </div>

    <script>
        setTimeout(() => {
            const loaderEl = document.getElementById('loader');
            const mainEl = document.getElementById('main-content');
            if (loaderEl && !loaderEl.classList.contains('opacity-0')) {
                loaderEl.classList.add('opacity-0', 'pointer-events-none');
                if (mainEl) mainEl.classList.remove('hidden');
                lucide.createIcons();
                console.log("Failsafe: Loading timeout dilewati.");
            }
        }, 2000);
    </script>

    <header class="md:hidden sticky top-0 left-0 right-0 z-50 px-5 pb-3 pt-[calc(env(safe-area-inset-top)+12px)] flex justify-between items-center bg-primary dark:bg-slate-900 transition-colors duration-300 shadow-sm">
        <div class="flex items-center gap-3.5">
            <div class="w-11 h-11 rounded-[0.8rem] bg-white/20 backdrop-blur-md p-1.5 flex items-center justify-center shrink-0 border border-white/30 shadow-sm">
                <img src="https://raw.githubusercontent.com/onelabszz/saktiapp/refs/heads/main/sakti.png" class="w-full h-full object-contain drop-shadow-md">
            </div>
            <div>
                <h1 class="font-black text-white text-xl leading-none tracking-tight drop-shadow-sm">Sakti App</h1>
                <p class="text-[10px] text-white/90 font-extrabold pt-1 tracking-widest uppercase">SD Negeri 3 Krisak</p>
            </div>
        </div>
    </header>

    <main id="main-content" class="relative z-10 w-full max-w-[1920px] mx-auto min-h-screen px-4 md:px-8 lg:px-10 xl:px-12 pt-5 pb-8 md:py-10 lg:py-12 flex flex-col md:flex-row gap-6 md:gap-8 lg:gap-12 hidden">
        
        <aside class="hidden md:flex flex-col md:sticky md:top-12 h-fit text-left fade-in md:w-[35%] lg:w-[28%] xl:w-[22%] max-w-[350px] shrink-0">
            <div class="w-24 h-24 lg:w-32 lg:h-32 rounded-[1.5rem] bg-white dark:bg-slate-800 p-4 lg:p-5 shadow-soft border border-orange-100 dark:border-slate-700 flex items-center justify-center mb-6 lg:mb-8 relative group">
                <div class="absolute inset-0 bg-orange-50 dark:bg-slate-700 rounded-[1.5rem] rotate-6 group-hover:rotate-12 transition -z-10"></div>
                <img src="https://raw.githubusercontent.com/onelabszz/saktiapp/refs/heads/main/sakti.png" alt="Logo" class="w-full h-full object-contain drop-shadow-sm">
            </div>
            <h1 class="text-3xl lg:text-4xl font-black text-slate-800 dark:text-white leading-none mb-2 tracking-tight">Sakti App</h1>
            <p class="text-slate-400 dark:text-slate-500 text-base lg:text-lg font-bold tracking-wide mb-5">SD Negeri 3 Krisak</p>
            <div class="inline-block px-3 py-1.5 bg-orange-50 dark:bg-orange-900/30 rounded-full border border-orange-200 dark:border-orange-800/50 mb-8 w-max">
                <p class="text-[10px] lg:text-xs font-extrabold text-primary uppercase tracking-wider">Berakhlak Cerdas Berprestasi</p>
            </div>
            <button onclick="openSettings()" class="ripple w-full bg-slate-800 dark:bg-primary hover:bg-slate-900 dark:hover:bg-primaryDark text-white font-bold py-4 rounded-[1.2rem] shadow-card transition flex justify-center items-center gap-2 lg:text-lg">
                <i data-lucide="settings-2" class="w-5 h-5 lg:w-6 lg:h-6"></i> Control Panel
            </button>
        </aside>

        <div class="flex flex-col gap-4 lg:gap-6 w-full md:w-[65%] lg:w-[72%] xl:w-[78%]">
            
            <div class="fade-in bg-gradient-to-br from-primary to-primaryDark dark:from-slate-800 dark:to-slate-900 rounded-[1.5rem] lg:rounded-[2.5rem] p-6 lg:p-10 text-white shadow-xl shadow-orange-500/30 dark:shadow-none relative overflow-hidden group border border-white/10 md:mt-0 transition-all duration-300">
                <div class="absolute right-[-50px] top-[-50px] w-64 h-64 lg:w-96 lg:h-96 bg-white/10 rounded-full blur-3xl pointer-events-none"></div>
                
                <div class="relative z-10 flex justify-between items-start mb-2">
                    <div class="max-w-3xl">
                        <div class="flex items-center gap-2 mb-3 lg:mb-4 text-white/90">
                            <i data-lucide="sparkles" class="w-4 h-4 lg:w-5 lg:h-5"></i>
                            <span class="text-xs lg:text-sm font-bold uppercase tracking-widest">Portal Digital</span>
                        </div>
                        <h2 id="greeting-text" class="text-2xl lg:text-4xl xl:text-5xl font-black leading-tight mb-2 lg:mb-3 drop-shadow-md">Selamat Datang!</h2>
                        <p id="greeting-desc" class="text-white/90 text-sm lg:text-lg xl:text-xl font-medium">Pilih aplikasi untuk memulai aktivitas.</p>
                    </div>
                </div>

                <div id="hero-ota-banner" class="hidden relative z-20 mt-6 lg:mt-8 pt-3 transition-all duration-500 origin-top max-w-4xl">
                    <div id="hero-ota-box" class="rounded-[1.2rem] p-4 lg:p-5 flex items-start gap-4 relative shadow-floating transform -translate-y-2 border border-white/20">
                        <div class="w-10 h-10 lg:w-12 lg:h-12 rounded-full bg-white/30 flex items-center justify-center shrink-0 border border-white/30 backdrop-blur-sm">
                            <i data-lucide="megaphone" class="w-5 h-5 lg:w-6 lg:h-6 text-white"></i>
                        </div>
                        <div class="flex-grow pr-8 lg:pt-0.5">
                            <h4 class="text-[9px] lg:text-[10px] font-black uppercase tracking-widest text-white/80 mb-1 lg:mb-1.5">Info Sekolah</h4>
                            <p class="text-xs lg:text-base font-bold text-white leading-snug drop-shadow-sm" id="hero-ota-text"></p>
                        </div>
                        <button onclick="closeHeroBanner()" class="absolute top-4 right-4 p-1.5 rounded-full text-white/80 hover:bg-white/40 hover:text-white transition active:scale-90">
                            <i data-lucide="x" class="w-4 h-4 lg:w-5 lg:h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-between px-1 fade-in mt-2 lg:mt-4">
                <div class="flex items-center gap-2.5">
                    <i data-lucide="layout-grid" class="w-4 h-4 lg:w-5 lg:h-5 text-primary"></i>
                    <span class="text-[10px] lg:text-xs font-extrabold text-slate-400 dark:text-slate-500 uppercase tracking-widest">Menu Layanan</span>
                </div>
                <i data-lucide="loader-2" id="sync-indicator" class="w-4 h-4 text-slate-300 animate-spin hidden"></i>
            </div>

            <div id="app-grid" class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-3.5 lg:gap-5"></div>
            
            <div class="mt-8 md:mt-12 text-center opacity-40 fade-in">
                <div class="flex justify-center items-center gap-1 mb-1.5"><i data-lucide="command" class="w-3 h-3 lg:w-4 lg:h-4"></i></div>
                <p class="text-slate-400 text-[9px] lg:text-[11px] font-bold tracking-widest uppercase">&copy; 2026 SDN 3 Krisak</p>
            </div>
        </div>
    </main>

    <button onclick="openSettings()" class="md:hidden fixed bottom-6 right-5 z-40 bg-gradient-to-br from-primary to-primaryDark dark:from-slate-800 dark:to-slate-900 text-white w-14 h-14 rounded-[1.2rem] shadow-floating dark:shadow-none flex items-center justify-center hover:scale-105 active:scale-90 transition-transform border border-white/20">
        <i data-lucide="settings-2" class="w-6 h-6"></i>
    </button>

    <div id="settings-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity duration-300" id="settings-bg" onclick="closeModals()"></div>
        <div class="bg-[#fdfbf7] dark:bg-slate-900 w-full max-w-md rounded-[1.5rem] shadow-2xl relative z-10 overflow-hidden transform scale-95 opacity-0 transition-all duration-200 flex flex-col max-h-[85vh]" id="settings-content">
            <div class="bg-white dark:bg-slate-800 px-6 py-5 flex justify-between items-center border-b border-slate-100 dark:border-slate-700 shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-orange-50 dark:bg-slate-700 text-primary rounded-lg flex items-center justify-center"><i data-lucide="sliders-horizontal" class="w-4 h-4"></i></div>
                    <h3 class="font-bold text-sm md:text-base text-slate-800 dark:text-white">Control Panel</h3>
                </div>
                <button onclick="closeModals()" class="text-slate-400 hover:text-slate-700 dark:hover:text-white transition bg-slate-50 dark:bg-slate-700 rounded-full p-1.5"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <div>
                    <h4 class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-3 px-1">Profil & Akun</h4>
                    <div id="settings-auth-container"></div>
                </div>
                <div>
                    <h4 class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-3 px-1">Tampilan</h4>
                    <button onclick="handleDarkToggle()" class="ripple w-full bg-white dark:bg-slate-800 p-4 rounded-[1rem] shadow-sm border border-slate-100 dark:border-slate-700 flex items-center justify-between transition group">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-yellow-400 group-hover:scale-110 transition-transform">
                                <i data-lucide="moon" id="panel-theme-icon" class="w-4 h-4"></i>
                            </div>
                            <div class="text-left">
                                <span class="block text-xs font-bold text-slate-700 dark:text-white" id="panel-theme-text">Mode Gelap</span>
                                <span class="block text-[9px] text-slate-400 font-medium">Ubah tema warna aplikasi</span>
                            </div>
                        </div>
                        <i data-lucide="refresh-ccw" class="w-4 h-4 text-slate-300 dark:text-slate-600 group-hover:rotate-180 transition-transform duration-500"></i>
                    </button>
                </div>
                <div>
                    <h4 class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-3 px-1">Sistem</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="optimizeApp()" class="ripple bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-white font-bold p-3 rounded-[1rem] shadow-sm border border-slate-100 dark:border-slate-700 transition flex flex-col items-center justify-center gap-2 text-center">
                            <div class="w-8 h-8 rounded-full bg-green-50 dark:bg-green-900/30 text-green-600 flex items-center justify-center"><i data-lucide="zap" class="w-4 h-4"></i></div>
                            <div><span class="block text-[11px]">Hapus Cache</span></div>
                        </button>
                        <button onclick="refreshApp()" class="ripple bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-white font-bold p-3 rounded-[1rem] shadow-sm border border-slate-100 dark:border-slate-700 transition flex flex-col items-center justify-center gap-2 text-center">
                            <div class="w-8 h-8 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center"><i data-lucide="rotate-cw" class="w-4 h-4"></i></div>
                            <div><span class="block text-[11px]">Muat Ulang</span></div>
                        </button>
                    </div>
                </div>
                <div class="pt-3 border-t border-slate-200 dark:border-slate-700 flex items-center justify-center gap-2 opacity-50">
                    <span class="text-[10px] font-bold text-slate-500">Sakti App</span>
                    <span id="app-version-panel" class="text-[9px] font-bold bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-1.5 py-0.5 rounded">v1.0</span>
                </div>
            </div>
        </div>
    </div>

    <div id="login-modal" class="fixed inset-0 z-[90] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity duration-300" id="login-bg" onclick="closeLogin()"></div>
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-[1.5rem] shadow-2xl relative z-10 overflow-hidden transform scale-95 opacity-0 transition-all duration-200 p-6 md:p-8" id="login-content">
            <button onclick="closeLogin()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-700 dark:hover:text-white bg-slate-50 dark:bg-slate-700 rounded-full p-1.5 transition"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <div class="w-14 h-14 bg-orange-50 dark:bg-slate-700 text-primary rounded-[1rem] shadow-soft flex items-center justify-center mx-auto mb-4 border border-orange-100 dark:border-slate-600">
                <i data-lucide="lock" class="w-6 h-6"></i>
            </div>
            <h3 class="text-xl font-black text-center text-slate-800 dark:text-white mb-1">Login Guru</h3>
            <p class="text-[10px] text-center text-slate-500 dark:text-slate-400 mb-5 font-medium">Masukkan PIN GTK Anda.</p>
            <form onsubmit="submitLogin(event)">
                <input type="password" id="login-pin" class="w-full text-center text-2xl tracking-[0.5em] font-black border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 dark:text-white rounded-xl py-3.5 mb-4 outline-none focus:border-primary transition" maxlength="6" required placeholder="••••••">
                <button type="submit" id="btn-submit-login" class="ripple w-full bg-slate-800 dark:bg-primary text-white text-sm font-bold py-3.5 rounded-xl hover:bg-slate-900 dark:hover:bg-primaryDark active:scale-95 transition shadow-lg flex justify-center items-center gap-2">
                    Masuk
                </button>
            </form>
        </div>
    </div>

    <div id="install-prompt-container" class="hidden"></div>
    <div id="install-sheet-overlay" class="fixed inset-0 z-[90] flex items-end justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity opacity-0" id="install-backdrop" onclick="closeModals()"></div>
        <div class="bg-white dark:bg-slate-800 w-full max-w-md mx-auto rounded-t-[1.5rem] p-5 shadow-2xl relative z-10 transform translate-y-full transition-transform duration-300" id="install-sheet">
            <div class="w-10 h-1.5 bg-slate-200 dark:bg-slate-600 rounded-full mx-auto mb-5"></div>
            <div class="text-center mb-5">
                <div class="w-14 h-14 bg-orange-50 dark:bg-slate-700 rounded-xl flex items-center justify-center mx-auto mb-3 border border-orange-100 dark:border-slate-600 shadow-soft p-2">
                    <img src="https://raw.githubusercontent.com/onelabszz/saktiapp/refs/heads/main/sakti.png" class="w-full h-full object-contain">
                </div>
                <h3 class="text-lg font-black text-slate-800 dark:text-white mb-1.5">Pasang Aplikasi</h3>
                <p class="text-[10px] text-slate-500 dark:text-slate-400 leading-relaxed px-2 font-medium">Install Sakti App ke HP Anda untuk akses lebih cepat.</p>
            </div>
            <div class="space-y-2.5">
                <button id="btn-install-now" class="ripple w-full bg-primary hover:bg-primaryDark text-white text-sm font-bold py-3.5 rounded-xl shadow-glow active:scale-95 transition flex justify-center items-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i><span>Pasang Sekarang</span>
                </button>
                <button onclick="closeModals()" class="w-full bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 font-bold py-3.5 rounded-xl transition text-[10px]">Nanti Saja</button>
            </div>
        </div>
    </div>

    <script>
        // --- API URL (TUTUP SCRIPT) ---
        const API_URL = "https://script.google.com/macros/s/AKfycbzzwvdqhcmsSub9Jpd75Kg-dwmCJ4OSL_GM3UT9MHNvSIx3d7rA7eV9HTq3vUYfp-0/exec";
        
        // --- HISTORY API ---
        window.addEventListener('popstate', (e) => { closeAllModalsUI(); });
        function pushModalState(modalId) { window.history.pushState({ modal: modalId }, ""); }
        function closeAllModalsUI() {
            const modals = [ { m: 'settings-modal', c: 'settings-content', bg: 'settings-bg' }, { m: 'login-modal', c: 'login-content', bg: 'login-bg' } ];
            modals.forEach(item => {
                const elContent = document.getElementById(item.c); const elModal = document.getElementById(item.m); const elBg = document.getElementById(item.bg);
                if(elContent) { elContent.classList.remove('scale-100', 'opacity-100'); elContent.classList.add('scale-95', 'opacity-0'); if(elBg) elBg.classList.add('opacity-0'); }
                setTimeout(() => { if(elModal) elModal.classList.add('hidden'); }, 200);
            });
        }
        function closeModals() { window.history.back(); }

        // --- THEME ---
        let isDarkMode = localStorage.getItem('sakti_theme') === 'dark' || (!('sakti_theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);

        function applyThemeUI() {
            const html = document.documentElement;
            if (isDarkMode) html.classList.add('dark'); else html.classList.remove('dark');
            updateGreetingText(); updateMetaTheme(); updatePanelThemeButton();
        }

        function updateMetaTheme() {
            const metaTheme = document.getElementById('meta-theme-color');
            if(metaTheme) metaTheme.setAttribute("content", isDarkMode ? "#0f172a" : "#FF9000");
        }

        function updatePanelThemeButton() {
            const icon = document.getElementById('panel-theme-icon');
            const text = document.getElementById('panel-theme-text');
            if(icon && text) {
                if (isDarkMode) { icon.setAttribute('data-lucide', 'sun'); text.innerText = 'Mode Terang'; } 
                else { icon.setAttribute('data-lucide', 'moon'); text.innerText = 'Mode Gelap'; }
                lucide.createIcons();
            }
        }

        function handleDarkToggle() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('sakti_theme', isDarkMode ? 'dark' : 'light');
            applyThemeUI();
        }

        function updateGreetingText() {
            const greeting = document.getElementById('greeting-text');
            const desc = document.getElementById('greeting-desc');
            const hour = new Date().getHours();
            let greetText = "Selamat Datang,";

            if (hour >= 5 && hour < 11) greetText = "Selamat Pagi,"; 
            else if (hour >= 11 && hour < 15) greetText = "Selamat Siang,"; 
            else if (hour >= 15 && hour < 18) greetText = "Selamat Sore,"; 
            else greetText = "Selamat Malam,"; 
            
            const userData = localStorage.getItem('sakti_user');
            if(userData) {
                const user = JSON.parse(userData);
                greetText += ` ${user.nama.split(' ')[0]}!`;
                if (desc) desc.innerText = user.jabatan || 'Guru SD Negeri 3 Krisak';
            } else {
                greetText += ` Guru!`;
                if (desc) desc.innerText = 'Pilih aplikasi untuk memulai aktivitas.';
            }
            if(greeting) greeting.innerText = greetText;
        }

        // --- CONTROL PANEL & LOGIN ---
        function renderAuthSection() {
            const container = document.getElementById('settings-auth-container');
            const userData = localStorage.getItem('sakti_user');
            if(userData) {
                const user = JSON.parse(userData);
                container.innerHTML = `
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-[1rem] p-5 text-white relative overflow-hidden shadow-soft mb-3">
                        <div class="absolute right-[-20px] top-[-20px] w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                        <div class="flex items-center gap-4 relative z-10">
                            <div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center text-2xl font-black border border-white/30 shrink-0 shadow-inner">${user.nama.charAt(0).toUpperCase()}</div>
                            <div>
                                <h3 class="font-bold text-base leading-tight mb-0.5 line-clamp-1 drop-shadow-sm">${user.nama}</h3>
                                <div class="inline-block px-2 py-0.5 bg-white/20 rounded text-[9px] font-bold uppercase tracking-wider">${user.jabatan || 'Guru'}</div>
                            </div>
                        </div>
                    </div>
                    <button onclick="confirmLogout()" class="ripple w-full bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 font-bold py-4 rounded-xl border border-red-100 dark:border-red-800/30 transition hover:bg-red-100 flex items-center justify-center gap-2 text-sm">
                        <i data-lucide="log-out" class="w-4 h-4"></i> Keluar Akun
                    </button>
                `;
            } else {
                container.innerHTML = `
                    <div class="bg-slate-100 dark:bg-slate-800 rounded-[1rem] p-5 text-center border border-slate-200 dark:border-slate-700 mb-3">
                        <div class="w-12 h-12 bg-white dark:bg-slate-700 text-slate-400 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm"><i data-lucide="user-x" class="w-6 h-6"></i></div>
                        <p class="text-xs font-bold text-slate-700 dark:text-white mb-0.5">Anda Belum Login</p>
                        <p class="text-[10px] text-slate-500 dark:text-slate-400 px-2">Masuk untuk menyimpan riwayat.</p>
                    </div>
                    <button onclick="openLogin()" class="ripple w-full bg-slate-800 dark:bg-primary text-white font-bold py-4 rounded-xl shadow-sm transition hover:bg-slate-900 flex items-center justify-center gap-2 text-sm">
                        <i data-lucide="log-in" class="w-4 h-4"></i> Login Guru
                    </button>
                `;
            }
            lucide.createIcons();
        }

        function openSettings() {
            pushModalState('settings-modal'); renderAuthSection(); 
            const modal = document.getElementById('settings-modal'); const bg = document.getElementById('settings-bg'); const content = document.getElementById('settings-content');
            modal.classList.remove('hidden');
            setTimeout(() => { bg.classList.remove('opacity-0'); content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
        }

        function openLogin() {
            window.history.replaceState({ modal: 'login-modal' }, "");
            const modalSet = document.getElementById('settings-modal'); const contentSet = document.getElementById('settings-content');
            contentSet.classList.remove('scale-100', 'opacity-100'); contentSet.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modalSet.classList.add('hidden');
                const modal = document.getElementById('login-modal'); const bg = document.getElementById('login-bg'); const content = document.getElementById('login-content');
                modal.classList.remove('hidden');
                setTimeout(() => { bg.classList.remove('opacity-0'); content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
            }, 200);
        }

        function closeLogin() {
            window.history.replaceState({ modal: 'settings-modal' }, "");
            const modalLogin = document.getElementById('login-modal'); const contentLogin = document.getElementById('login-content');
            contentLogin.classList.remove('scale-100', 'opacity-100'); contentLogin.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modalLogin.classList.add('hidden');
                const modalSet = document.getElementById('settings-modal'); const contentSet = document.getElementById('settings-content');
                modalSet.classList.remove('hidden');
                setTimeout(() => { contentSet.classList.remove('scale-95', 'opacity-0'); contentSet.classList.add('scale-100', 'opacity-100'); }, 10);
            }, 200);
        }

        async function submitLogin(e) {
            e.preventDefault();
            const pin = document.getElementById('login-pin').value; const btn = document.getElementById('btn-submit-login');
            btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Memeriksa...'; lucide.createIcons(); btn.disabled = true;

            try {
                const res = await fetch(`${API_URL}?action=user_login&pin=${pin}`); const data = await res.json();
                if (data.status === 'success') {
                    localStorage.setItem('sakti_user', JSON.stringify(data.user));
                    Swal.fire({ icon: 'success', title: 'Berhasil Masuk', text: `Selamat datang!`, timer: 1000, showConfirmButton: false });
                    updateGreetingText(); window.history.back(); 
                } else { Swal.fire({ icon: 'error', title: 'Akses Ditolak', text: data.message, confirmButtonColor: '#FF9000' }); }
            } catch (err) { Swal.fire({ icon: 'error', title: 'Koneksi Terputus', text: 'Coba lagi nanti.', confirmButtonColor: '#FF9000' }); }
            btn.innerHTML = 'Masuk'; btn.disabled = false; document.getElementById('login-pin').value = ''; lucide.createIcons();
        }

        function confirmLogout() {
            Swal.fire({
                title: 'Keluar Akun?', text: "Anda harus login kembali untuk akses khusus.", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Ya, Keluar', cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('sakti_user'); updateGreetingText(); renderAuthSection();
                    Swal.fire({ icon: 'success', title: 'Berhasil Keluar', showConfirmButton: false, timer: 1000 });
                }
            });
        }

        function refreshApp() {
            window.history.back();
            setTimeout(() => window.location.reload(), 300);
        }

        function optimizeApp() {
            window.history.back(); 
            Swal.fire({
                title: 'Optimasi Aplikasi?', text: "Membersihkan cache untuk memuat pembaruan menu.", icon: 'question',
                showCancelButton: true, confirmButtonColor: '#10b981', cancelButtonColor: '#cbd5e1', confirmButtonText: 'Ya, Bersihkan', cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    if('caches' in window) { caches.keys().then(names => { names.forEach(name => caches.delete(name)); }); }
                    localStorage.removeItem('sakti_data_cache'); 
                    Swal.fire({ icon: 'success', title: 'Cache Dibersihkan', text: 'Memuat ulang aplikasi...', showConfirmButton: false, timer: 1000 });
                    setTimeout(() => window.location.reload(true), 1000);
                }
            });
        }

        // --- FETCH & RENDER DATA ---
        const colorPalette = {
            blue: { gradient: 'from-blue-500 to-indigo-600', shadow: 'shadow-blue-500/30', infoBox: 'bg-blue-600 border-blue-500' },
            red: { gradient: 'from-red-500 to-rose-600', shadow: 'shadow-red-500/30', infoBox: 'bg-red-600 border-red-500' },
            green: { gradient: 'from-emerald-400 to-teal-500', shadow: 'shadow-emerald-500/30', infoBox: 'bg-emerald-600 border-emerald-500' },
            orange: { gradient: 'from-orange-400 to-orange-600', shadow: 'shadow-orange-500/30', infoBox: 'bg-orange-600 border-orange-500' },
            purple: { gradient: 'from-purple-500 to-fuchsia-600', shadow: 'shadow-purple-500/30', infoBox: 'bg-purple-600 border-purple-500' },
            teal: { gradient: 'from-teal-400 to-cyan-500', shadow: 'shadow-teal-500/30', infoBox: 'bg-teal-600 border-teal-500' },
            yellow: { gradient: 'from-amber-400 to-orange-500', shadow: 'shadow-amber-500/30', infoBox: 'bg-amber-500 border-amber-400' }
        };

        window.addEventListener('DOMContentLoaded', async () => {
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(console.error);
            applyThemeUI();

            const cachedData = localStorage.getItem('sakti_data_cache');
            if (cachedData) { renderData(JSON.parse(cachedData)); } 

            try {
                if (cachedData) document.getElementById('sync-indicator').classList.remove('hidden'); 
                const response = await fetch(`${API_URL}?action=public_load`);
                const data = await response.json();
                if (data.status === "success") {
                    localStorage.setItem('sakti_data_cache', JSON.stringify(data));
                    renderData(data); 
                }
            } catch (err) { console.log("Offline:", err); } 
            finally { 
                document.getElementById('sync-indicator').classList.add('hidden'); 
                // Matikan loader dengan aman (meski gagal fetch / local dev)
                const loaderEl = document.getElementById('loader');
                if(loaderEl && !loaderEl.classList.contains('opacity-0')){
                    loaderEl.classList.add('opacity-0', 'pointer-events-none');
                    document.getElementById('main-content').classList.remove('hidden');
                    lucide.createIcons();
                }
            }
        });

        function renderData(data) {
            if(data.info.versi) {
                const vPanel = document.getElementById('app-version-panel');
                const vHero = document.getElementById('app-version');
                if(vPanel) vPanel.innerText = data.info.versi;
                if(vHero) vHero.innerText = data.info.versi;
            }
            
            const banner = document.getElementById('hero-ota-banner');
            if (data.info.status === 'ON' && data.info.pesan) {
                const box = document.getElementById('hero-ota-box');
                const selColor = colorPalette[data.info.warna] ? colorPalette[data.info.warna].infoBox : 'bg-blue-600 border-blue-500';
                box.className = `rounded-[1.2rem] p-4 lg:p-5 flex items-start gap-4 relative shadow-floating transform -translate-y-2 border ${selColor}`;
                document.getElementById('hero-ota-text').innerText = data.info.pesan;
                banner.classList.remove('hidden');
            } else { banner.classList.add('hidden'); }

            const grid = document.getElementById('app-grid');
            grid.innerHTML = ''; let delayCounter = 0;

            data.raw_menu.forEach((row, index) => {
                if (index === 0 || !row[0]) return; 
                const target = (row[5] || "all").toLowerCase();
                const displayClass = target === "mobile" ? "block md:hidden" : target === "desktop" ? "hidden md:block" : "block";
                const isWide = (row[7] || "").toLowerCase() === "wide";
                const spanClass = isWide ? "col-span-2 md:col-span-2 lg:col-span-2 xl:col-span-2" : "col-span-1";
                const badgeHTML = row[8] ? `<span class="absolute top-0 right-0 bg-red-500 text-white text-[8px] lg:text-[9px] font-bold px-2.5 py-1 rounded-bl-[1rem] shadow-sm uppercase z-20">${row[8]}</span>` : "";
                const colors = colorPalette[row[4]] || colorPalette['blue'];

                if (isWide) {
                    grid.insertAdjacentHTML('beforeend', `
                        <a href="${row[2]}" class="${displayClass} ${spanClass} fade-in" style="animation-delay: ${delayCounter}ms">
                            <div class="ripple bg-gradient-to-br ${colors.gradient} p-4 lg:p-5 rounded-[1.2rem] lg:rounded-[1.5rem] shadow-md ${colors.shadow} hover:-translate-y-1 transition-all active:scale-[0.98] group relative overflow-hidden flex items-center gap-3 lg:gap-5 h-full border border-white/10">
                                ${badgeHTML}
                                <div class="absolute right-[-20px] top-[-20px] w-32 h-32 lg:w-48 lg:h-48 bg-white/20 rounded-full blur-2xl group-hover:scale-125 transition-transform duration-700 pointer-events-none"></div>
                                <div class="w-12 h-12 lg:w-16 lg:h-16 shrink-0 bg-white/20 backdrop-blur-md rounded-[1rem] lg:rounded-[1.2rem] flex items-center justify-center text-white border border-white/30 shadow-inner group-hover:bg-white/30 transition-colors relative z-10">
                                    <i data-lucide="${row[3] || 'info'}" class="w-6 h-6 lg:w-8 lg:h-8"></i>
                                </div>
                                <div class="flex-grow pr-2 lg:pr-4 relative z-10">
                                    <h3 class="text-sm lg:text-xl font-bold text-white line-clamp-1 drop-shadow-sm">${row[0]}</h3>
                                    <p class="text-[10px] lg:text-sm text-white/80 font-medium line-clamp-1 lg:line-clamp-2 mt-0.5 lg:mt-1">${row[1]}</p>
                                </div>
                                <div class="w-8 h-8 lg:w-10 lg:h-10 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center text-white shrink-0 relative z-10 group-hover:bg-white group-hover:text-slate-800 transition-colors shadow-sm"><i data-lucide="arrow-right" class="w-4 h-4 lg:w-5 lg:h-5"></i></div>
                            </div>
                        </a>
                    `);
                } else {
                    grid.insertAdjacentHTML('beforeend', `
                        <a href="${row[2]}" class="${displayClass} ${spanClass} fade-in" style="animation-delay: ${delayCounter}ms">
                            <div class="ripple bg-gradient-to-br ${colors.gradient} p-4 lg:p-5 rounded-[1.2rem] lg:rounded-[1.5rem] shadow-md ${colors.shadow} hover:-translate-y-1 transition-all active:scale-[0.98] group relative overflow-hidden flex flex-col justify-between min-h-[110px] lg:min-h-[160px] border border-white/10 h-full">
                                ${badgeHTML}
                                <div class="absolute -right-6 -top-6 w-24 h-24 lg:w-32 lg:h-32 bg-white/20 rounded-full blur-2xl group-hover:scale-150 transition-transform duration-700 pointer-events-none"></div>
                                <div class="w-10 h-10 lg:w-14 lg:h-14 bg-white/20 backdrop-blur-md rounded-[1rem] lg:rounded-[1.2rem] flex items-center justify-center text-white border border-white/30 shadow-inner group-hover:bg-white/30 transition-colors mb-2.5 lg:mb-4 relative z-10">
                                    <i data-lucide="${row[3] || 'circle'}" class="w-5 h-5 lg:w-7 lg:h-7"></i>
                                </div>
                                <div class="relative z-10 pr-1">
                                    <h3 class="text-xs lg:text-lg font-bold text-white line-clamp-1 drop-shadow-sm">${row[0]}</h3>
                                    <p class="text-[9px] lg:text-xs text-white/80 font-medium line-clamp-2 mt-0.5 lg:mt-1 leading-snug">${row[1]}</p>
                                </div>
                                <div class="absolute bottom-3 lg:bottom-4 right-3 lg:right-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300 text-white/60"><i data-lucide="${target === 'desktop' ? 'external-link' : 'arrow-right'}" class="w-4 h-4 lg:w-5 lg:h-5"></i></div>
                            </div>
                        </a>
                    `);
                }
                delayCounter += 20; 
            });
            lucide.createIcons();
        }

        function closeHeroBanner() {
            const banner = document.getElementById('hero-ota-banner');
            banner.classList.add('opacity-0', '-translate-y-4', 'scale-95');
            setTimeout(() => banner.classList.add('hidden'), 400);
        }

        // --- PWA INSTALL PROMPT ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });
        function hideInstallSheet() { closeModals(); }
    </script>
</body>
</html>
